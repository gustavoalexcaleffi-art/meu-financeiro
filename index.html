<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Financeiro Pro v46.28</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root { --primary: #2c3e50; --success: #27ae60; --danger: #e74c3c; --bg: #f4f7f6; --info: #2980b9; --gray: #95a5a6; --warning: #f39c12; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); margin: 0; padding: 10px; color: #333; }
        .container { max-width: 800px; margin: auto; background: white; border-radius: 12px; overflow: hidden; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        .nav { display: flex; background: #fff; border-bottom: 2px solid #eee; }
        .nav button { flex: 1; padding: 15px 2px; border: none; cursor: pointer; background: none; font-weight: bold; color: var(--gray); font-size: 0.7rem; text-transform: uppercase; }
        .nav button.active { color: var(--success); border-bottom: 3px solid var(--success); background: #f9fffb; }
        .content { padding: 15px; display: none; }
        .content.active { display: block; }
        .card { background: #fff; padding: 12px; border-radius: 10px; border: 1px solid #eee; text-align: center; margin-bottom: 10px; }
        .val-pos { color: var(--success) !important; font-weight: bold; }
        .val-neg { color: var(--danger) !important; font-weight: bold; }
        .form-group { display: flex; flex-direction: column; gap: 8px; margin-bottom: 15px; padding: 12px; background: #fcfcfc; border: 1px solid #eee; border-radius: 10px; border-left: 5px solid var(--info); }
        input, select { padding: 10px; border: 1px solid #ccc; border-radius: 8px; font-size: 1rem; }
        label { font-size: 0.7rem; font-weight: bold; color: var(--gray); margin-bottom: -5px; margin-left: 5px; }
        .main-btn { width: 100%; padding: 12px; background: var(--success); color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; margin-bottom: 5px; }
        .del-btn { background: var(--danger) !important; margin-top: 5px; }
        .badge { padding: 6px 10px; border-radius: 6px; font-size: 0.65rem; font-weight: 800; color: white; cursor: pointer; text-transform: uppercase; display: inline-block; min-width: 90px; text-align: center; border: none; }
        .badge-success { background: var(--success); }
        .badge-pending { background: #7f8c8d; }
        .neg-alert { background: var(--danger); color: white; padding: 10px; border-radius: 8px; margin-bottom: 10px; text-align: center; font-size: 0.85rem; font-weight: bold; }
        .ranking-item { display: flex; align-items: center; margin-bottom: 8px; gap: 10px; }
        .ranking-label { flex: 1; font-size: 0.75rem; font-weight: bold; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
        .ranking-bar-bg { flex: 2; height: 10px; background: #eee; border-radius: 5px; overflow: hidden; }
        .ranking-bar-fill { height: 100%; background: var(--danger); border-radius: 5px; }
        .ranking-val { flex: 1; text-align: right; font-size: 0.75rem; font-weight: bold; }
        table { width: 100%; border-collapse: collapse; font-size: 0.8rem; margin-top: 10px; }
        th { text-align: left; padding: 8px; border-bottom: 2px solid #eee; background: #f9f9f9; }
        td { padding: 8px; border-bottom: 1px solid #eee; }
        .version-tag { text-align: center; font-size: 0.6rem; color: #ccc; margin-top: 15px; padding-bottom: 10px; }
    </style>
</head>
<body>

<div class="container">
    <div class="nav">
        <button onclick="openTab(event, 'tab-dash')" class="active">Resumo</button>
        <button onclick="openTab(event, 'tab-livro')">Fluxo</button>
        <button onclick="openTab(event, 'tab-transacoes')">Lan√ßamento</button>
        <button onclick="openTab(event, 'tab-config')">Config</button>
    </div>

    <div style="background: #fff; padding: 8px; border-bottom: 1px solid #eee; display: flex; justify-content: center;">
        <input type="month" id="filter-mes" onchange="renderAll()">
    </div>

    <div id="tab-dash" class="content active">
        <div id="neg-alert" class="neg-alert" style="display:none"></div>
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
            <div class="card"><small>Dispon√≠vel (Efetivado)</small><div id="dash-cc-total" style="font-size:1.2rem">R$ 0,00</div><div id="dash-cc-lista" style="font-size:0.7rem; color:#666; text-align:left; margin-top:5px"></div></div>
            <div class="card"><small>Investimento (Efetivado)</small><div id="dash-inv-total" style="font-weight:bold; color:var(--info); font-size:1.2rem">R$ 0,00</div><div id="dash-inv-lista" style="font-size:0.7rem; color:#666; text-align:left; margin-top:5px"></div></div>
        </div>
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top:10px;">
            <div class="card"><h6>Mensal</h6><canvas id="chartComp" height="180"></canvas></div>
            <div class="card"><h6>Patrim√¥nio</h6><canvas id="chartEvolucao" height="180"></canvas></div>
        </div>
        <div class="card" style="text-align: left; padding: 15px;">
            <h6 style="margin: 0 0 10px 0; color: var(--gray); text-transform: uppercase; font-size: 0.7rem;">Ranking de Despesas por Categoria</h6>
            <div id="ranking-despesas"></div>
        </div>
    </div>

    <div id="tab-livro" class="content">
        <h3>üìä Fluxo de Caixa (Sem Rendimentos)</h3>
        <table>
            <thead><tr><th>Dia</th><th>Descri√ß√£o</th><th>Valor</th><th>Saldo Acum.</th></tr></thead>
            <tbody id="lista-fluxo"></tbody>
        </table>
    </div>

    <div id="tab-transacoes" class="content">
        <div class="form-group">
            <input type="hidden" id="t-id"><h4 style="margin:0; color:var(--info)">Lan√ßamento</h4>
            <label>Data</label><input type="date" id="t-data">
            <label>Tipo</label>
            <select id="t-tipo" onchange="toggleFields()">
                <option value="Despesa">Despesa</option><option value="Receita">Receita</option>
                <option value="Rendimento">Rendimento</option><option value="Transferencia">Transfer√™ncia</option>
            </select>
            <label>Descri√ß√£o</label><input type="text" id="t-nome" placeholder="Ex: Aluguel">
            <label>Valor R$</label><input type="number" id="t-valor" placeholder="0,00" step="0.01">
            
            <label id="lbl-conta-origem">Conta</label>
            <select id="t-conta"></select>
            
            <div id="box-destino" style="display:none">
                <label style="color:var(--success)">Para Conta (ENTRADA)</label>
                <select id="t-conta-destino"></select>
            </div>

            <label id="lbl-cat">Categoria</label>
            <select id="t-cat"></select>
            
            <button class="main-btn" onclick="handleSave()">Salvar</button>
            <button id="btn-delete" class="main-btn del-btn" onclick="handleDelete()" style="display:none">Excluir Lan√ßamento</button>
            <button id="btn-cancel" onclick="clearForm()" style="display:none; background:#999; color:white; padding:8px; border-radius:8px; border:none; width:100%; margin-top:5px">Cancelar</button>
        </div>
        <div id="lista-transacoes"></div>
    </div>

    <div id="tab-config" class="content">
        <button class="main-btn" onclick="exportData()" style="background:var(--info)">üíæ EXPORTAR BACKUP</button>
        <button class="main-btn" onclick="document.getElementById('importFile').click()" style="background:#8e44ad">üìÇ IMPORTAR BACKUP</button>
        <input type="file" id="importFile" style="display:none" onchange="importData(event)">
        <hr>
        <div class="form-group">
            <h4>Categorias</h4>
            <div style="display:flex; gap:5px"><input type="text" id="new-cat" style="flex:1"><button onclick="addCat()">+</button></div>
            <div id="lista-categorias-config" style="margin-top:10px"></div>
        </div>
        <div class="form-group">
            <h4>Contas</h4>
            <input type="text" id="c-nome" placeholder="Nome"><select id="c-tipo"><option value="Corrente">Corrente</option><option value="Investimento">Investimento</option></select>
            <input type="number" id="c-saldo" placeholder="Saldo Inicial"><button class="main-btn" onclick="addAccount()">Add Conta</button>
            <div id="lista-contas-config" style="margin-top:10px"></div>
        </div>
    </div>

    <div class="version-tag">Financeiro Pro v46.28</div>
</div>

<script>
    const KEY = 'finance_v44';
    let db = JSON.parse(localStorage.getItem(KEY)) || { transacoes: [], contas: [], categorias: ['Sal√°rio'], lastBackup: null };
    const fmt = (v) => v.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
    document.getElementById('filter-mes').value = new Date().toISOString().substring(0, 7);

    function save() { localStorage.setItem(KEY, JSON.stringify(db)); renderAll(); }

    function renderAll() {
        const [ano, mes] = document.getElementById('filter-mes').value.split('-').map(Number);
        const dataFimMes = new Date(ano, mes, 0, 23, 59, 59);

        document.getElementById('t-conta').innerHTML = db.contas.map(c => `<option value="${c.nome}">${c.nome}</option>`).join('');
        document.getElementById('t-cat').innerHTML = db.categorias.map(c => `<option value="${c}">${c}</option>`).join('');
        document.getElementById('t-conta-destino').innerHTML = document.getElementById('t-conta').innerHTML;
        
        document.getElementById('lista-categorias-config').innerHTML = db.categorias.map((c,i) => `<div class="config-item">${c}<button onclick="db.categorias.splice(${i},1);save()">‚úñ</button></div>`).join('');
        document.getElementById('lista-contas-config').innerHTML = db.contas.map((c,i) => `<div class="config-item">${c.nome}<button onclick="db.contas.splice(${i},1);save()">‚úñ</button></div>`).join('');

        const ordenadas = [...db.transacoes].sort((a,b) => new Date(a.data + 'T00:00:00') - new Date(b.data + 'T00:00:00'));
        let saldosReal = {}; db.contas.forEach(c => saldosReal[c.nome] = parseFloat(c.saldoInicial) || 0);
        let saldoProjFluxo = 0; db.contas.forEach(c => { if(c.tipo === 'Corrente') saldoProjFluxo += c.saldoInicial; });

        let fluxoHtml = "", entMes = 0, saiMes = 0, diasNegativos = [];
        let gastosCategoria = {};

        ordenadas.forEach(t => {
            const dt = new Date(t.data + 'T00:00:00');
            if (dt > dataFimMes) return;

            // L√≥gica de Saldo Real (Dashboard) - CORRIGIDA
            if (t.concluido) {
                if(t.tipo === 'Transferencia') {
                    saldosReal[t.conta] -= Math.abs(t.valor);
                    saldosReal[t.contaDestino] += Math.abs(t.valor);
                } else {
                    saldosReal[t.conta] += t.valor;
                }
            }

            // L√≥gica de Fluxo de Caixa (Livro)
            if (t.tipo !== 'Rendimento') {
                const cO = db.contas.find(c => c.nome === t.conta), cD = db.contas.find(c => c.nome === t.contaDestino);
                let imp = 0;
                if(t.tipo === 'Transferencia') {
                    if(cO?.tipo === 'Corrente' && cD?.tipo !== 'Corrente') imp = -Math.abs(t.valor);
                    else if(cO?.tipo !== 'Corrente' && cD?.tipo === 'Corrente') imp = Math.abs(t.valor);
                } else if(cO?.tipo === 'Corrente') { imp = t.valor; }
                saldoProjFluxo += imp;

                if (dt.getMonth() === mes-1 && dt.getFullYear() === ano) {
                    if(t.tipo !== 'Transferencia') { 
                        if(t.valor > 0) entMes += t.valor; 
                        else { saiMes += Math.abs(t.valor); gastosCategoria[t.cat] = (gastosCategoria[t.cat] || 0) + Math.abs(t.valor); }
                    }
                    fluxoHtml += `<tr style="${!t.concluido?'color:#777;font-style:italic':''}"><td>${dt.getDate()}</td><td>${t.nome}</td><td class="${t.valor>=0?'val-pos':'val-neg'}">${fmt(t.valor)}</td><td class="${saldoProjFluxo>=0?'val-pos':'val-neg'}">${fmt(saldoProjFluxo)}</td></tr>`;
                    if(saldoProjFluxo < 0) diasNegativos.push(dt.getDate());
                }
            }
        });

        // Ranking
        const rankingSorted = Object.entries(gastosCategoria).sort((a,b) => b[1] - a[1]);
        const maxGasto = rankingSorted.length > 0 ? rankingSorted[0][1] : 0;
        document.getElementById('ranking-despesas').innerHTML = rankingSorted.map(([cat, val]) => `<div class="ranking-item"><div class="ranking-label">${cat}</div><div class="ranking-bar-bg"><div class="ranking-bar-fill" style="width: ${(val/maxGasto)*100}%"></div></div><div class="ranking-val">${fmt(val)}</div></div>`).join('') || '<small>Nenhum gasto.</small>';
        
        document.getElementById('lista-fluxo').innerHTML = fluxoHtml;
        const alertBox = document.getElementById('neg-alert');
        if(diasNegativos.length > 0) { alertBox.style.display = 'block'; alertBox.innerText = `üö® Saldo de caixa negativo nos dias: ${[...new Set(diasNegativos)].join(', ')}`; } else { alertBox.style.display = 'none'; }

        // Dash UI
        let tCC = 0, tInv = 0, hCC = "", hInv = "";
        db.contas.forEach(c => {
            const v = saldosReal[c.nome];
            const line = `<div style="display:flex;justify-content:space-between"><span>${c.nome}</span><b>${fmt(v)}</b></div>`;
            if(c.tipo === 'Corrente') { tCC += v; hCC += line; } else { tInv += v; hInv += line; }
        });
        document.getElementById('dash-cc-total').innerText = fmt(tCC); document.getElementById('dash-cc-lista').innerHTML = hCC;
        document.getElementById('dash-inv-total').innerText = fmt(tInv); document.getElementById('dash-inv-lista').innerHTML = hInv;
        renderCharts(entMes, saiMes, ano, mes); renderLancamentos();
    }

    function renderCharts(e, s, ano, mes) {
        if(window.c1) window.c1.destroy();
        window.c1 = new Chart(document.getElementById('chartComp'), { type:'bar', data:{labels:['Rec','Desp'], datasets:[{data:[e,s], backgroundColor:['#27ae60','#e74c3c']}]}, options:{responsive:true, plugins:{legend:{display:false}}}});
        let labels=[], dados=[];
        for(let i=4; i>=0; i--) {
            let dF = new Date(ano, (mes-1)-i + 1, 0, 23, 59, 59); labels.push(new Date(ano, (mes-1)-i, 1).toLocaleDateString('pt-BR', {month:'short'}));
            let total = 0; db.contas.forEach(c => total += c.saldoInicial);
            db.transacoes.forEach(t => { if(t.concluido && new Date(t.data+'T00:00:00') <= dF) total += t.valor; });
            dados.push(total);
        }
        if(window.c2) window.c2.destroy();
        window.c2 = new Chart(document.getElementById('chartEvolucao'), { type:'line', data:{labels, datasets:[{data:dados, borderColor:'#2980b9', fill:true, backgroundColor:'rgba(41,128,185,0.1)'}]}, options:{responsive:true, plugins:{legend:{display:false}}}});
    }

    function renderLancamentos() {
        document.getElementById('lista-transacoes').innerHTML = db.transacoes.slice(0,25).map(t => `
            <div style="display:flex; justify-content:space-between; padding:10px 5px; border-bottom:1px solid #eee; align-items:center" onclick="editT(${t.id})">
                <button class="badge ${t.concluido ? 'badge-success' : 'badge-pending'}" onclick="event.stopPropagation(); toggleSt(${t.id})">${t.concluido ? 'EFETIVADO' : 'PENDENTE'}</button>
                <div style="flex:1; margin: 0 10px;"><small>${t.data}</small><br><b>${t.nome}</b></div>
                <b class="${t.valor>=0?'val-pos':'val-neg'}">${fmt(t.valor)}</b>
            </div>`).join('');
    }

    function editT(id) {
        const t = db.transacoes.find(x => x.id === id);
        document.getElementById('t-id').value = t.id; document.getElementById('t-nome').value = t.nome;
        document.getElementById('t-valor').value = Math.abs(t.valor); document.getElementById('t-data').value = t.data;
        document.getElementById('t-tipo').value = t.tipo; document.getElementById('t-conta').value = t.conta;
        document.getElementById('t-cat').value = t.cat; 
        if(t.tipo === 'Transferencia') document.getElementById('t-conta-destino').value = t.contaDestino;
        document.getElementById('btn-cancel').style.display = 'block';
        document.getElementById('btn-delete').style.display = 'block';
        toggleFields(); window.scrollTo(0,0);
    }

    function handleDelete() {
        const id = parseInt(document.getElementById('t-id').value);
        if(id && confirm("Excluir este lan√ßamento?")) { db.transacoes = db.transacoes.filter(x => x.id !== id); clearForm(); save(); }
    }

    function handleSave() {
        const id = document.getElementById('t-id').value, v = Math.abs(parseFloat(document.getElementById('t-valor').value)), tipo = document.getElementById('t-tipo').value;
        if(!v) return;
        const obj = { id: id ? parseInt(id) : Date.now(), nome: document.getElementById('t-nome').value, valor: tipo === 'Despesa' ? -v : v, tipo, data: document.getElementById('t-data').value, conta: document.getElementById('t-conta').value, contaDestino: document.getElementById('t-conta-destino').value, cat: document.getElementById('t-cat').value, concluido: id ? db.transacoes.find(x => x.id === parseInt(id)).concluido : false };
        if(id) db.transacoes[db.transacoes.findIndex(x => x.id === parseInt(id))] = obj;
        else db.transacoes.unshift(obj);
        clearForm(); save();
    }

    function toggleSt(id) { const t=db.transacoes.find(x=>x.id===id); t.concluido=!t.concluido; save(); }
    function clearForm() { document.getElementById('t-id').value=""; document.getElementById('t-nome').value=""; document.getElementById('t-valor').value=""; document.getElementById('btn-cancel').style.display='none'; document.getElementById('btn-delete').style.display='none'; }
    function addCat() { const n=document.getElementById('new-cat').value; if(n){ db.categorias.push(n); save(); } }
    function addAccount() { db.contas.push({nome:document.getElementById('c-nome').value, tipo:document.getElementById('c-tipo').value, saldoInicial:parseFloat(document.getElementById('c-saldo').value)||0}); save(); }
    function exportData() { db.lastBackup = Date.now(); const a = document.createElement('a'); a.href = URL.createObjectURL(new Blob([JSON.stringify(db)], {type:'application/json'})); a.download = `backup.json`; a.click(); save(); }
    function importData(e) { const r = new FileReader(); r.onload=(ev)=>{ db=JSON.parse(ev.target.result); save(); location.reload(); }; r.readAsText(e.target.files[0]); }
    function openTab(e, n) { document.querySelectorAll(".content").forEach(c => c.classList.remove("active")); document.querySelectorAll(".nav button").forEach(b => b.classList.remove("active")); document.getElementById(n).classList.add("active"); if(e) e.currentTarget.classList.add("active"); renderAll(); }
    
    function toggleFields() { 
        const isTrf = document.getElementById('t-tipo').value === 'Transferencia';
        document.getElementById('box-destino').style.display = isTrf ? 'block' : 'none';
        document.getElementById('lbl-conta-origem').innerText = isTrf ? "Conta (SA√çDA)" : "Conta";
        document.getElementById('lbl-cat').style.display = isTrf ? 'none' : 'block';
        document.getElementById('t-cat').style.display = isTrf ? 'none' : 'block';
    }

    renderAll();
</script>
</body>
</html>
