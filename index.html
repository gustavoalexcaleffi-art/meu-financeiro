<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Financeiro Pro v46.11</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <style>
        :root { --primary: #2c3e50; --success: #27ae60; --danger: #e74c3c; --bg: #f4f7f6; --warning: #f39c12; --info: #2980b9; --gray: #95a5a6; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); margin: 0; padding: 10px; color: #333; }
        .container { max-width: 800px; margin: auto; background: white; border-radius: 12px; overflow: hidden; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        .nav { display: flex; background: #fff; border-bottom: 2px solid #eee; }
        .nav button { flex: 1; padding: 15px 2px; border: none; cursor: pointer; background: none; font-weight: bold; color: var(--gray); font-size: 0.7rem; text-transform: uppercase; }
        .nav button.active { color: var(--success); border-bottom: 3px solid var(--success); background: #f9fffb; }
        .content { padding: 15px; display: none; }
        .content.active { display: block; }
        
        /* Alertas */
        .alert-box { padding: 12px; text-align: center; font-size: 0.85rem; font-weight: bold; margin-bottom: 10px; border-radius: 8px; }
        .negative-alert { background: var(--danger); color: white; display: none; }

        /* Badges com nomes completos */
        .badge { 
            padding: 6px 10px; 
            border-radius: 6px; 
            font-size: 0.65rem; 
            font-weight: 800; 
            color: white; 
            cursor: pointer; 
            text-transform: uppercase; 
            display: inline-block;
            min-width: 80px; /* Aumentado para caber o texto */
            text-align: center;
            border: none;
        }
        .badge-success { background: var(--success); }
        .badge-pending { background: #7f8c8d; }

        .card { background: #fff; padding: 12px; border-radius: 10px; border: 1px solid #eee; text-align: center; margin-bottom: 10px; }
        .val-pos { color: var(--success) !important; font-weight: bold; }
        .val-neg { color: var(--danger) !important; font-weight: bold; }
        
        .form-group { display: flex; flex-direction: column; gap: 8px; margin-bottom: 15px; padding: 12px; background: #fcfcfc; border: 1px solid #eee; border-radius: 10px; border-left: 5px solid var(--info); }
        input, select { padding: 10px; border: 1px solid #ccc; border-radius: 8px; font-size: 1rem; }
        .main-btn { width: 100%; padding: 12px; background: var(--success); color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; margin-bottom: 5px; }
        
        .config-item { display: flex; justify-content: space-between; align-items: center; padding: 8px; border-bottom: 1px solid #eee; font-size: 0.85rem; }
        .btn-del { background: none; border: none; color: var(--danger); cursor: pointer; font-weight: bold; }
        
        table { width: 100%; border-collapse: collapse; font-size: 0.8rem; }
        th { text-align: left; padding: 8px; border-bottom: 2px solid #eee; }
        td { padding: 8px; border-bottom: 1px solid #eee; }
        
        #modalQR { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.9); z-index:1000; justify-content:center; align-items:center; flex-direction:column; color:white; padding: 20px; }
        .version-tag { text-align: center; font-size: 0.6rem; color: #ccc; margin-top: 15px; padding-bottom: 10px; }
    </style>
</head>
<body>

<div class="container">
    <div class="nav">
        <button onclick="openTab(event, 'tab-dash')" class="active">Resumo</button>
        <button onclick="openTab(event, 'tab-livro')">Fluxo</button>
        <button onclick="openTab(event, 'tab-transacoes')">Lan√ßamento</button>
        <button onclick="openTab(event, 'tab-config')">Config</button>
    </div>

    <div style="background: #fff; padding: 8px; border-bottom: 1px solid #eee; display: flex; justify-content: center;">
        <input type="month" id="filter-mes" onchange="renderAll()">
    </div>

    <div id="tab-dash" class="content active">
        <div id="neg-alert" class="alert-box negative-alert"></div>
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
            <div class="card">
                <small>Saldo Dispon√≠vel Atual</small>
                <div id="dash-cc-total" style="font-size:1.2rem">R$ 0,00</div>
                <div id="dash-cc-lista" style="font-size:0.7rem; color:#666; text-align:left; margin-top:5px"></div>
            </div>
            <div class="card">
                <small>Investimento Atual</small>
                <div id="dash-inv-total" style="font-weight:bold; color:var(--info); font-size:1.2rem">R$ 0,00</div>
                <div id="dash-inv-lista" style="font-size:0.7rem; color:#666; text-align:left; margin-top:5px"></div>
            </div>
        </div>
        <div class="card" style="text-align: left;">
            <h6>üèÜ Ranking de Despesas (M√™s)</h6>
            <div id="ranking-despesas"></div>
        </div>
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
            <div class="card"><h6>Rec. x Desp.</h6><div class="chart-container"><canvas id="chartComp" height="150"></canvas></div></div>
            <div class="card"><h6>Patrim√¥nio</h6><div class="chart-container"><canvas id="chartEvolucao" height="150"></canvas></div></div>
        </div>
    </div>

    <div id="tab-transacoes" class="content">
        <div class="form-group" id="form-container">
            <input type="hidden" id="t-id">
            <h4 id="form-title" style="margin:0 0 10px 0; color:var(--info)">Novo Lan√ßamento</h4>
            <input type="date" id="t-data">
            <select id="t-tipo" onchange="toggleFields()">
                <option value="Despesa">Despesa</option>
                <option value="Receita">Receita</option>
                <option value="Rendimento">Rendimento</option>
                <option value="Transferencia">Transfer√™ncia</option>
            </select>
            <input type="text" id="t-nome" placeholder="Descri√ß√£o">
            <input type="number" id="t-valor" placeholder="Valor R$" step="0.01">
            <select id="t-conta"></select>
            <select id="t-conta-destino" style="display:none"></select>
            <select id="t-cat"></select>
            <div style="display:flex; gap:5px">
                <button class="main-btn" onclick="handleSave()">Salvar</button>
                <button class="main-btn" id="btn-cancel" onclick="clearForm()" style="background:var(--gray); display:none">Cancelar</button>
            </div>
        </div>
        <div id="lista-transacoes"></div>
    </div>

    <div id="tab-livro" class="content">
        <h3>üìä Fluxo de Caixa Mensal</h3>
        <table>
            <thead><tr><th>Dia</th><th>Descri√ß√£o</th><th>Valor</th><th>Saldo</th></tr></thead>
            <tbody id="lista-fluxo"></tbody>
        </table>
    </div>

    <div id="tab-config" class="content">
        <button class="main-btn" onclick="generateQR()" style="background:var(--primary)">üì± GERAR QR CODE SINCRONIZAR</button>
        <hr>
        <div class="form-group">
            <h4>Categorias</h4>
            <div style="display:flex; gap:5px"><input type="text" id="new-cat" style="flex:1"><button onclick="addCat()" style="background:var(--success); color:white; border:none; border-radius:8px; width:40px">+</button></div>
            <div id="lista-categorias-config" style="margin-top:10px"></div>
        </div>
        <div class="form-group">
            <h4>Contas</h4>
            <input type="text" id="c-nome" placeholder="Nome Banco"><select id="c-tipo"><option value="Corrente">Corrente</option><option value="Investimento">Investimento</option></select>
            <input type="number" id="c-saldo" placeholder="Saldo Inicial"><button class="main-btn" onclick="addAccount()" style="background:#333">Add Conta</button>
            <div id="lista-contas-config" style="margin-top:10px"></div>
        </div>
        <button class="main-btn" onclick="exportData()" style="background:var(--info)">üíæ EXPORTAR BACKUP</button>
        <button class="main-btn" onclick="document.getElementById('importFile').click()" style="background:#8e44ad">üìÇ IMPORTAR BACKUP</button>
        <input type="file" id="importFile" style="display:none" onchange="importData(event)">
    </div>

    <div class="version-tag">Financeiro Pro v46.11 - Intelig√™ncia Local</div>
</div>

<div id="modalQR" onclick="this.style.display='none'">
    <div id="qrcode" style="background:white; padding:15px; border-radius:10px"></div>
    <p style="margin-top:15px; font-size:0.9rem">Toque para fechar</p>
</div>

<script>
    const KEY = 'finance_v44';
    let db = JSON.parse(localStorage.getItem(KEY)) || { transacoes: [], contas: [], categorias: ['Geral', 'Sal√°rio', 'Alimenta√ß√£o'], lastBackup: null };
    const fmt = (v) => v.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
    document.getElementById('filter-mes').value = new Date().toISOString().substring(0, 7);
    document.getElementById('t-data').valueAsDate = new Date();

    function save() { localStorage.setItem(KEY, JSON.stringify(db)); renderAll(); }

    function renderAll() {
        const [ano, mes] = document.getElementById('filter-mes').value.split('-').map(Number);
        const hoje = new Date(); hoje.setHours(23,59,59,999);

        document.getElementById('t-conta').innerHTML = db.contas.map(c => `<option value="${c.nome}">${c.nome}</option>`).join('');
        document.getElementById('t-cat').innerHTML = db.categorias.map(c => `<option value="${c}">${c}</option>`).join('');
        document.getElementById('t-conta-destino').innerHTML = document.getElementById('t-conta').innerHTML;
        
        document.getElementById('lista-categorias-config').innerHTML = db.categorias.map((c,i) => `<div class="config-item">${c} <button class="btn-del" onclick="db.categorias.splice(${i},1);save()">‚úñ</button></div>`).join('');
        document.getElementById('lista-contas-config').innerHTML = db.contas.map((c,i) => `<div class="config-item"><span><b>${c.nome}</b> (${c.tipo})</span> <button class="btn-del" onclick="db.contas.splice(${i},1);save()">‚úñ</button></div>`).join('');

        let saldoFluxo = 0;
        db.contas.forEach(c => { if(c.tipo === 'Corrente') saldoFluxo += c.saldoInicial; });
        let saldosReais = {}; db.contas.forEach(c => saldosReais[c.nome] = c.saldoInicial);

        const transSorted = [...db.transacoes].sort((a,b) => new Date(a.data) - new Date(b.data));
        let eM = 0, sM = 0, diasNegativos = [], rankingMap = {}, htmlFluxo = "";

        transSorted.forEach(t => {
            const dt = new Date(t.data + 'T00:00:00');
            const noMes = (dt.getMonth() === mes-1 && dt.getFullYear() === ano);
            
            let impCC = 0;
            const cI = db.contas.find(c => c.nome === t.conta);
            const cD = db.contas.find(c => c.nome === t.contaDestino);

            if(t.tipo === 'Transferencia') {
                if(cI?.tipo === 'Corrente' && cD?.tipo !== 'Corrente') impCC = -Math.abs(t.valor);
                if(cI?.tipo !== 'Corrente' && cD?.tipo === 'Corrente') impCC = Math.abs(t.valor);
            } else if(cI?.tipo === 'Corrente' && t.tipo !== 'Rendimento') {
                impCC = t.valor;
            }

            saldoFluxo += impCC;
            if(noMes && saldoFluxo < 0 && !diasNegativos.includes(dt.getDate())) diasNegativos.push(dt.getDate());

            if(t.concluido && dt <= hoje) {
                if(t.tipo === 'Transferencia') { saldosReais[t.conta] -= Math.abs(t.valor); saldosReais[t.contaDestino] += Math.abs(t.valor); }
                else { saldosReais[t.conta] += t.valor; }
            }

            if(noMes && t.tipo !== 'Rendimento') {
                if(t.valor > 0) eM += t.valor; else sM += Math.abs(t.valor);
                if(t.valor < 0) rankingMap[t.cat] = (rankingMap[t.cat] || 0) + Math.abs(t.valor);
                htmlFluxo += `<tr><td>${dt.getDate()}</td><td>${t.nome}</td><td class="${t.valor>=0?'val-pos':'val-neg'}">${fmt(t.valor)}</td><td class="${saldoFluxo>=0?'val-pos':'val-neg'}">${fmt(saldoFluxo)}</td></tr>`;
            }
        });

        const elCC = document.getElementById('dash-cc-total');
        let tCC=0, tInv=0, hCC="", hInv="";
        db.contas.forEach(c => {
            const s = saldosReais[c.nome];
            const item = `<div style="display:flex;justify-content:space-between"><span>${c.nome}</span><b>${fmt(s)}</b></div>`;
            if(c.tipo==='Corrente'){ tCC+=s; hCC+=item; } else { tInv+=s; hInv+=item; }
        });
        
        elCC.innerText = fmt(tCC);
        elCC.className = tCC < 0 ? 'val-neg' : 'val-pos';
        document.getElementById('dash-cc-lista').innerHTML = hCC;
        document.getElementById('dash-inv-total').innerText = fmt(tInv);
        document.getElementById('dash-inv-lista').innerHTML = hInv;
        document.getElementById('lista-fluxo').innerHTML = htmlFluxo;

        document.getElementById('neg-alert').style.display = diasNegativos.length ? 'block' : 'none';
        document.getElementById('neg-alert').innerHTML = `üö® Saldo negativo previsto nos dias: ${diasNegativos.join(', ')}`;

        renderRanking(rankingMap, sM);
        renderCharts(eM, sM, ano, mes);
        renderLancamentos();
    }

    function renderLancamentos() {
        document.getElementById('lista-transacoes').innerHTML = db.transacoes.slice(0,40).map(t => `
            <div class="item-row" style="display:flex; justify-content:space-between; padding:12px 10px; border-bottom:1px solid #eee; align-items:center" onclick="editT(${t.id})">
                <button class="badge ${t.concluido ? 'badge-success' : 'badge-pending'}" onclick="event.stopPropagation(); toggleSt(${t.id})">
                    ${t.concluido ? 'Efetivado' : 'Pendente'}
                </button>
                <div style="flex:1; margin: 0 12px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">
                    <small style="color:#888">${t.data}</small><br><b>${t.nome}</b>
                </div>
                <div class="${t.valor>=0?'val-pos':'val-neg'}">${fmt(t.valor)}</div>
                <button onclick="event.stopPropagation(); delT(${t.id})" style="border:none; background:none; cursor:pointer; margin-left:12px; font-size:1.2rem">üóëÔ∏è</button>
            </div>`).join('');
    }

    function handleSave() {
        const id = document.getElementById('t-id').value;
        const v = Math.abs(parseFloat(document.getElementById('t-valor').value));
        const tipo = document.getElementById('t-tipo').value;
        if(!v || !document.getElementById('t-nome').value) return alert("Preencha Nome e Valor");
        const obj = { id: id ? parseInt(id) : Date.now(), nome: document.getElementById('t-nome').value, valor: (tipo === 'Despesa') ? -v : v, tipo, data: document.getElementById('t-data').value, conta: document.getElementById('t-conta').value, contaDestino: document.getElementById('t-conta-destino').value, cat: document.getElementById('t-cat').value, concluido: true };
        if(id) { const i = db.transacoes.findIndex(x => x.id === parseInt(id)); db.transacoes[i] = obj; }
        else { db.transacoes.unshift(obj); }
        clearForm(); save();
    }

    function editT(id) {
        const t = db.transacoes.find(x => x.id === id);
        document.getElementById('t-id').value = t.id;
        document.getElementById('t-nome').value = t.nome;
        document.getElementById('t-valor').value = Math.abs(t.valor);
        document.getElementById('t-data').value = t.data;
        document.getElementById('t-tipo').value = t.tipo;
        document.getElementById('t-conta').value = t.conta;
        document.getElementById('t-cat').value = t.cat;
        document.getElementById('form-title').innerText = "‚úèÔ∏è Editando Registro";
        document.getElementById('btn-cancel').style.display = "block";
        toggleFields(); window.scrollTo(0,0);
    }

    function clearForm() {
        document.getElementById('t-id').value = ""; document.getElementById('t-nome').value = "";
        document.getElementById('t-valor').value = ""; document.getElementById('form-title').innerText = "Novo Lan√ßamento";
        document.getElementById('btn-cancel').style.display = "none";
    }

    function generateQR() {
        document.getElementById('modalQR').style.display = 'flex';
        document.getElementById('qrcode').innerHTML = "";
        new QRCode(document.getElementById("qrcode"), { text: JSON.stringify(db), width: 250, height: 250 });
    }

    function renderRanking(rankingMap, total) {
        const sorted = Object.entries(rankingMap).sort((a,b) => b[1]-a[1]).slice(0,5);
        document.getElementById('ranking-despesas').innerHTML = sorted.map(([cat, val]) => {
            const pct = total ? (val/total*100).toFixed(0) : 0;
            return `<div style="margin-bottom:8px; font-size:0.8rem">
                <div style="display:flex;justify-content:space-between"><span>${cat}</span><b>${fmt(val)}</b></div>
                <div style="background:#eee; height:4px; border-radius:2px; margin-top:2px"><div style="background:var(--danger); height:100%; width:${pct}%"></div></div>
            </div>`;
        }).join('') || "<small>Sem gastos.</small>";
    }

    function renderCharts(e, s, ano, mes) {
        if(window.c1) window.c1.destroy();
        window.c1 = new Chart(document.getElementById('chartComp'), {
            type:'bar', data:{labels:['Rec','Desp'], datasets:[{data:[e,s], backgroundColor:['#27ae60','#c0392b']}]},
            options:{ responsive:true, maintainAspectRatio:false, plugins:{legend:{display:false}} }
        });
        let labels=[], data=[];
        for(let i=4; i>=0; i--) {
            let dF = new Date(ano, (mes-1)-i + 1, 0);
            labels.push(new Date(ano, (mes-1)-i, 1).toLocaleDateString('pt-BR', {month:'short'}));
            let total = 0; db.contas.forEach(c => total += c.saldoInicial);
            db.transacoes.forEach(t => { if(t.concluido && new Date(t.data+'T00:00:00') <= dF) total += t.valor; });
            data.push(total);
        }
        if(window.c2) window.c2.destroy();
        window.c2 = new Chart(document.getElementById('chartEvolucao'), {
            type:'line', data:{labels, datasets:[{data, borderColor:'#27ae60', fill:true, backgroundColor:'rgba(39,174,96,0.1)'}]},
            options:{ responsive:true, maintainAspectRatio:false, plugins:{legend:{display:false}} }
        });
    }

    function toggleFields() { document.getElementById('t-conta-destino').style.display = document.getElementById('t-tipo').value==='Transferencia'?'block':'none'; }
    function toggleSt(id) { const t=db.transacoes.find(x=>x.id===id); t.concluido=!t.concluido; save(); }
    function delT(id) { if(confirm("Excluir?")){ db.transacoes=db.transacoes.filter(x=>x.id!==id); save(); } }
    function addCat() { const n = document.getElementById('new-cat').value; if(n){ db.categorias.push(n); document.getElementById('new-cat').value=''; save(); } }
    function addAccount() { db.contas.push({nome:document.getElementById('c-nome').value, tipo:document.getElementById('c-tipo').value, saldoInicial:parseFloat(document.getElementById('c-saldo').value)||0}); save(); }
    function openTab(e, n) { document.querySelectorAll(".content").forEach(c => c.classList.remove("active")); document.querySelectorAll(".nav button").forEach(b => b.classList.remove("active")); document.getElementById(n).classList.add("active"); e.currentTarget.classList.add("active"); renderAll(); }
    function exportData() { const a = document.createElement('a'); a.href=URL.createObjectURL(new Blob([JSON.stringify(db)], {type:'application/json'})); a.download=`backup_v4611.json`; a.click(); }
    function importData(e) { const r = new FileReader(); r.onload = (ev) => { db = JSON.parse(ev.target.result); save(); location.reload(); }; r.readAsText(e.target.files[0]); }

    renderAll();
</script>
</body>
</html>
